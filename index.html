<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Doncaster Coffee Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Mapbox GL JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <!-- Mapbox Search Box -->
  <script src="https://api.mapbox.com/search-js/v1.0.0-beta.21/web.js"></script>
  <style>
    body { 
      margin: 0; 
      padding: 0; 
      font-family: sans-serif; 
    }
    
    #map { 
      position: absolute; 
      top: 0; 
      bottom: 0; 
      width: 100%; 
    }

    /* Style the Mapbox search box */
    #search-container {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1;
      width: 90%;
      max-width: 400px;
    }

    mapbox-search-box {
      width: 100%;
    }

    /* Custom popup styling */
    .mapboxgl-popup-content {
      background-color: rgba(255, 255, 255, 0.85) !important;
      border-radius: 6px;
      padding: 8px 12px;
      font-family: sans-serif;
      max-width: 220px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.2);
    }

    .custom-popup strong {
      font-weight: bold;
      display: block;
      margin-bottom: 4px;
    }

    .custom-popup p {
      font-size: 0.85em;
      font-style: italic;
      margin: 0 0 6px;
    }

    .custom-popup .directions-btn {
      background-color: #EA736B;
      color: white;
      padding: 6px 10px;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      font-size: 0.85em;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      text-decoration: none;
    }

    .custom-popup .directions-btn:hover {
      background-color: #d8655e;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <!-- Mapbox Search Box replaces your custom search -->
  <div id="search-container">
    <mapbox-search-box 
      access-token="pk.eyJ1Ijoic2lnaHRzZWVrciIsImEiOiJjbWJheDU5dWwwbjZqMmxzYjRqaW0wZ2FoIn0.XjR_Z_6vL3dcXrVECelgiA"
      options='{"language": "en", "country": "GB", "proximity": [-1.133, 53.522]}'
      placeholder="Search for places in Doncaster..."
      theme="light">
    </mapbox-search-box>
  </div>

<script>
  // Function to initialize the map once mapboxgl is available
  function initializeMap() {
    mapboxgl.accessToken = 'pk.eyJ1Ijoic2lnaHRzZWVrciIsImEiOiJjbWJheDU5dWwwbjZqMmxzYjRqaW0wZ2FoIn0.XjR_Z_6vL3dcXrVECelgiA';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/sightseekr/cmdlr4rap009h01r23f5z6h7i',
      center: [-1.133, 53.522],
      zoom: 11.3
    });

    // Add navigation controls
    map.addControl(new mapboxgl.NavigationControl());
    map.addControl(new mapboxgl.GeolocateControl({
      positionOptions: { enableHighAccuracy: true },
      trackUserLocation: true,
      showUserHeading: true
    }));

    // Directions links for your coffee shops
    const directionsLinks = {
      "West Street Coffee": "https://www.google.com/maps?cid=7732098197170659430",
      "Cafe 1910 (In Danum Gallery, Library and Museum)": "https://www.google.com/maps?cid=1008549081973229459",
      "Bone Idle Lounge": "https://google.com/maps?cid=11035181184400722709",
      "Da Leo Restaurant": "https://www.google.com/maps?cid=6913375424484086838",
      "Doncaster Tourist Information Centre": "https://www.google.com/maps?cid=674239188930906122",
      "The Glass Strawberry": "https://www.google.com/maps?cid=17678315068369981247",
      "Banco Coffee Co": "https://www.google.com/maps?cid=1769371057472287012",
      "Jazz Cafe": "https://www.google.com/maps?cid=14635295943506975263",
      "Old man Staveley's coffee co": "https://www.google.com/maps?cid=11699623048919577819",
      "Back in Time Caf√©": "http://google.com/maps?cid=10559689921745810730",
      "Boston & Co Bentley Pavilion": "https://www.google.com/maps?cid=9765442256895214233",
      "Jimmy Piggs Coffee House": "https://www.google.com/maps?cid=9568668619399891490",
      "Cornerstone Coffee": "https://www.google.com/maps?cid=272364922763009188",
      "Highfield Coffee Social": "https://www.google.com/maps?cid=14653791595216298550",
      "TWEED at Wadworth": "https://www.google.com/maps?cid=9866149075741907923",
      "Feast Bawtry": "https://www.google.com/maps?cid=14094552448568676862"
    };

    let currentPopup = null;
    let popupOpenedByClick = false;

    // Function to create popup
    function createPopup(feature, lngLat, clicked = false) {
      if (currentPopup) currentPopup.remove();
      popupOpenedByClick = clicked;

      const name = feature.properties ? feature.properties.name : feature.name;
      const description = feature.properties ? feature.properties.description : feature.description;
      const directions = directionsLinks[name] || `https://www.google.com/maps/search/${encodeURIComponent(name)}`;

      currentPopup = new mapboxgl.Popup({ closeButton: false })
        .setLngLat(lngLat)
        .setHTML(`
          <div class="custom-popup">
            <strong>${name || "No title"}</strong>
            <p>${description || "No description"}</p>
            <a href="${directions}" class="directions-btn" target="_blank">
              <span>Directions</span> <span>üìç</span>
            </a>
          </div>
        `)
        .addTo(map);
    }

    // Connect the search box to the map
    const searchBox = document.querySelector('mapbox-search-box');
    
    // When a search result is selected, fly to it
    searchBox.addEventListener('retrieve', (event) => {
      const feature = event.detail;
      if (feature && feature.geometry && feature.geometry.coordinates) {
        map.flyTo({
          center: feature.geometry.coordinates,
          zoom: 14
        });
        
        // Create popup for the search result
        setTimeout(() => {
          createPopup({
            name: feature.properties.name || feature.properties.full_address,
            description: feature.properties.address || "Search result"
          }, feature.geometry.coordinates, true);
        }, 300);
      }
    });

    // Set up map interactions when map loads
    map.on('load', () => {
      const layers = ['city-centre-new', 'across-doncaster'];

      // Hover popup for your coffee shop layers
      layers.forEach(layer => {
        map.on('mouseenter', layer, e => {
          map.getCanvas().style.cursor = 'pointer';
          createPopup(e.features[0], e.lngLat, false);
        });

        map.on('mouseleave', layer, () => {
          map.getCanvas().style.cursor = '';
          if (!popupOpenedByClick && currentPopup) {
            currentPopup.remove();
            currentPopup = null;
          }
        });

        // Click to keep popup open
        map.on('click', layer, e => {
          createPopup(e.features[0], e.lngLat, true);
        });
      });

      // Global click: close popup if user clicks on empty map space
      map.on('click', (e) => {
        const features = map.queryRenderedFeatures(e.point, { layers });
        if (!features.length && currentPopup) {
          currentPopup.remove();
          currentPopup = null;
          popupOpenedByClick = false;
        }
      });
    });

  } // End of initializeMap function

  // Wait for both DOM and mapboxgl to be ready
  function checkAndInit() {
    if (typeof mapboxgl !== 'undefined') {
      initializeMap();
    } else {
      // If mapboxgl isn't ready yet, wait a bit and try again
      setTimeout(checkAndInit, 100);
    }
  }

  // Start checking once DOM is loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', checkAndInit);
  } else {
    checkAndInit();
  }

</script>
</body>
</html>


